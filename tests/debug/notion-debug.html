<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion API 调试工具</title>
    <style>
        body { background: #0a0a0a; color: white; font-family: monospace; padding: 20px; }
        .section { background: rgba(255,255,255,0.05); border: 1px solid #00ffff; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .title { color: #00ffff; font-size: 18px; margin-bottom: 15px; }
        .button { background: linear-gradient(45deg, #00ffff, #0080ff); color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        .input { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid #333; border-radius: 4px; color: white; margin: 5px 0; }
        .output { background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 4px; padding: 15px; margin: 15px 0; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: rgba(0,255,0,0.1); border: 1px solid rgba(0,255,0,0.3); color: #00ff00; }
        .error { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #ff6b6b; }
        .info { background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); color: #00ffff; }
    </style>
</head>
<body>
    <h1 style="color: #00ffff; text-align: center;">🔧 Notion API 调试工具</h1>
    
    <div class="section">
        <div class="title">1. 配置测试</div>
        <input type="password" id="apiKey" class="input" placeholder="Notion API Key">
        <input type="text" id="databaseId" class="input" placeholder="Database ID">
        <button class="button" onclick="testConfig()">测试配置</button>
        <button class="button" onclick="loadConfig()">加载配置</button>
        <div id="configStatus" class="status info">请输入配置信息</div>
    </div>
    
    <div class="section">
        <div class="title">2. 连接测试</div>
        <button class="button" onclick="testConnection()">测试API连接</button>
        <button class="button" onclick="testDatabase()">测试数据库</button>
        <button class="button" onclick="testSimpleQuery()">简单查询</button>
        <div id="connectionStatus" class="status info">点击测试连接</div>
        <div id="connectionOutput" class="output" style="display: none;"></div>
    </div>
    
    <div class="section">
        <div class="title">3. 修复建议</div>
        <div style="color: #ccc; font-size: 14px;">
            <p><strong>常见错误和解决方案：</strong></p>
            <ul>
                <li><strong>body.filter错误：</strong> 检查过滤器格式，确保所有字段都存在</li>
                <li><strong>unauthorized：</strong> 检查API Key是否正确</li>
                <li><strong>not_found：</strong> 检查Database ID是否正确</li>
                <li><strong>validation_error：</strong> 检查数据库字段结构</li>
            </ul>
        </div>
    </div>

    <script>
        let config = { apiKey: '', databaseId: '' };
        
        function updateStatus(id, msg, type) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `status ${type}`;
        }
        
        function updateOutput(id, content) {
            const el = document.getElementById(id);
            el.textContent = content;
            el.style.display = 'block';
        }
        
        function loadConfig() {
            try {
                const stored = localStorage.getItem('notion_config');
                if (stored) {
                    const data = JSON.parse(stored);
                    document.getElementById('apiKey').value = data.apiKey || '';
                    document.getElementById('databaseId').value = data.databaseId || '';
                    updateStatus('configStatus', '✅ 配置已加载', 'success');
                } else {
                    updateStatus('configStatus', '⚠️ 未找到存储的配置', 'error');
                }
            } catch (e) {
                updateStatus('configStatus', '❌ 加载失败: ' + e.message, 'error');
            }
        }
        
        function testConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const databaseId = document.getElementById('databaseId').value.trim();
            
            if (!apiKey || !databaseId) {
                updateStatus('configStatus', '❌ 请填写完整配置', 'error');
                return;
            }
            
            config = { apiKey, databaseId };
            updateStatus('configStatus', '✅ 配置已设置', 'success');
        }
        
        async function testConnection() {
            if (!config.apiKey) {
                updateStatus('connectionStatus', '❌ 请先设置配置', 'error');
                return;
            }
            
            updateStatus('connectionStatus', '🔄 测试连接中...', 'info');
            
            try {
                const response = await fetch('https://api.notion.com/v1/users/me', {
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Notion-Version': '2022-06-28'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('connectionStatus', '✅ API连接成功', 'success');
                    updateOutput('connectionOutput', JSON.stringify(data, null, 2));
                } else {
                    updateStatus('connectionStatus', '❌ API连接失败', 'error');
                    updateOutput('connectionOutput', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                updateStatus('connectionStatus', '❌ 连接错误: ' + error.message, 'error');
                updateOutput('connectionOutput', error.stack);
            }
        }
        
        async function testDatabase() {
            if (!config.apiKey || !config.databaseId) {
                updateStatus('connectionStatus', '❌ 请先设置配置', 'error');
                return;
            }
            
            updateStatus('connectionStatus', '🔄 测试数据库访问...', 'info');
            
            try {
                const response = await fetch(`https://api.notion.com/v1/databases/${config.databaseId}`, {
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Notion-Version': '2022-06-28'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('connectionStatus', '✅ 数据库访问成功', 'success');
                    updateOutput('connectionOutput', JSON.stringify(data, null, 2));
                } else {
                    updateStatus('connectionStatus', '❌ 数据库访问失败', 'error');
                    updateOutput('connectionOutput', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                updateStatus('connectionStatus', '❌ 数据库错误: ' + error.message, 'error');
                updateOutput('connectionOutput', error.stack);
            }
        }
        
        async function testSimpleQuery() {
            if (!config.apiKey || !config.databaseId) {
                updateStatus('connectionStatus', '❌ 请先设置配置', 'error');
                return;
            }
            
            updateStatus('connectionStatus', '🔄 测试简单查询...', 'info');
            
            try {
                const requestBody = { page_size: 3 };
                
                const response = await fetch(`https://api.notion.com/v1/databases/${config.databaseId}/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Notion-Version': '2022-06-28',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('connectionStatus', `✅ 查询成功，找到 ${data.results.length} 条记录`, 'success');
                    updateOutput('connectionOutput', JSON.stringify(data, null, 2));
                } else {
                    updateStatus('connectionStatus', '❌ 查询失败', 'error');
                    updateOutput('connectionOutput', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                updateStatus('connectionStatus', '❌ 查询错误: ' + error.message, 'error');
                updateOutput('connectionOutput', error.stack);
            }
        }
        
        // 自动加载配置
        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>