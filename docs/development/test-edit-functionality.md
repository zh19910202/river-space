# 文章编辑功能测试指南

## 功能概述

本系统现在支持对已发表的文章进行二次编辑功能，包括：

### 新增功能

1. **文章编辑接口**
   - 从Notion加载现有文章数据
   - 将Notion块转换为Markdown格式
   - 支持所有文章属性的编辑（标题、摘要、分类、标签、封面图、内容等）

2. **后端编辑支持**
   - `notionWriteService.updateBlogPage()` - 更新页面属性
   - `notionWriteService.replacePageContent()` - 替换页面内容
   - `notionWriteService.buildUpdateData()` - 构建更新数据

3. **前端编辑界面**
   - 编辑按钮在文章详情模态框中显示（仅管理员可见）
   - 编辑器标题显示当前模式（创建新文章/编辑文章）
   - 新建文章按钮用于重置编辑状态

4. **权限验证**
   - 编辑功能需要GitHub认证
   - 权限检查方法 `hasEditPermission()`
   - 统一的权限验证 `validateEditPermission()`

## 测试步骤

### 1. 准备工作
- 确保Notion API配置正确
- 确保有GitHub Personal Access Token
- 确保博客中已有发布的文章

### 2. 认证测试
1. 访问博客页面
2. 通过右下角连续点击3次或URL参数`?admin=true`打开管理面板
3. 使用GitHub Personal Access Token进行认证
4. 验证认证成功后显示编辑器界面

### 3. 编辑功能测试
1. 点击任意已发布的文章查看详情
2. 验证在文章详情模态框顶部显示"编辑文章"按钮（仅认证用户可见）
3. 点击"编辑文章"按钮
4. 验证：
   - 模态框关闭
   - 管理面板打开
   - 表单自动填充现有文章数据
   - 编辑器标题显示"编辑文章"
   - 发布按钮文本显示"更新文章"

### 4. 数据加载测试
验证以下数据是否正确加载：
- 文章标题
- 分类
- 标签（逗号分隔）
- 阅读时间
- 封面图URL和预览
- 文章摘要
- 文章内容（Markdown格式）

### 5. 编辑和保存测试
1. 修改文章的各个字段
2. 点击"更新文章"按钮
3. 验证更新过程：
   - 显示"更新中..."状态
   - 更新Notion页面属性
   - 更新Notion页面内容
   - 上传到GitHub
   - 显示"更新成功"消息

### 6. 新建文章测试
1. 在编辑状态下点击"新建文章"按钮
2. 验证：
   - 表单清空
   - 编辑器标题显示"创建新文章"
   - 发布按钮文本显示"发布文章"
   - 编辑状态重置

### 7. 权限测试
1. 未认证状态下尝试编辑文章
2. 验证显示权限错误消息
3. 注销后验证编辑按钮不显示

## 技术实现要点

### 1. 数据转换
- Notion富文本 → 纯文本提取
- Notion块 → Markdown转换
- 属性值提取（标题、选择、多选、URL等）

### 2. 状态管理
- `editingArticleId` - 当前编辑的文章ID
- `editingArticleData` - 当前编辑的文章数据
- 编辑模式UI状态切换

### 3. 原子性操作
- 编辑模式不执行回滚（避免误删现有数据）
- 新建模式保持原有回滚机制
- 错误处理和状态恢复

### 4. 用户体验
- 点击编辑按钮自动关闭模态框
- 平滑的状态切换动画
- 清晰的操作反馈消息

## 已知限制

1. **Notion API限制**
   - 删除块操作可能失败（Notion API限制）
   - 某些块类型转换可能不完整

2. **GitHub同步**
   - 编辑时会创建新的GitHub文件
   - 不会自动删除旧的GitHub文件

3. **并发编辑**
   - 不支持多用户同时编辑同一文章
   - 基于最后保存优先原则

## 故障排除

### 常见问题
1. **权限错误** - 检查GitHub认证状态
2. **加载失败** - 检查Notion API配置和文章ID
3. **更新失败** - 检查网络连接和API权限
4. **数据丢失** - 检查表单验证和必填字段

### 调试方法
- 查看浏览器控制台日志
- 检查网络请求状态
- 验证Notion数据库结构
- 确认GitHub仓库权限

## 总结

文章编辑功能已完全集成到现有系统中，提供了完整的CRUD操作支持。用户可以方便地编辑已发布的文章，同时保持了系统的安全性和数据一致性。